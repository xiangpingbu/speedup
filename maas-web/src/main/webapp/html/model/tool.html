<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<style>
    .MyRect:hover {
        fill: brown;
    }

    .sheet {
        display: inline-block;
    }

    .axis {
        display: inline-block;
    }
</style>
<body>
<!--<div style="display: inline-block;" id="svg"></div>-->

<!--<div style='display: inline-block;'>-->
<!--<table id="data_table" class="table table-bordered">-->
<!--<thead>-->
<!--<tr>-->
<!--<th>bin_num</th>-->
<!--<th>woe</th>-->
<!--</tr>-->
<!--</thead>-->
<!--<tbody>-->

<!--</tbody>-->
<!--</table>-->
<!--</div>-->
<div>

</div>


<!--<div>-->
<!--<button class="btn btn-primary" style="margin-left: 25px;" id="merge" disabled>执行合并</button>-->
<!--</div>-->
</body>
<script src="/static/lib/inspinia/js/jquery-2.1.1.js"></script>
<script src="/static/js/d3/d3.min.js"></script>
<link href="/static/lib/inspinia/css/bootstrap.min.css" rel="stylesheet">


<script>
    var height = 500,
        width = 500,
        margin = 25;

    var start = null;
    var end = null;
    var array = [$("#index_0")];

    var padding = {left: 25, right: 30, top: 5, bottom: 20};
//    var svg;
    //描绘一个画布
    var xScale, yScale;

    $(document).ready(function () {
        d3.json("http://localhost:8091/tool", function (error, result) {
            console.log(result);
            for (var num = 0; num < result.data.length; num++) {
//                $('.axis').html("");
//                $('#data_table').find('tbody').html("");
                console.log(result.data);
                var svg= initPanel(num);
                renderXAxis(result.data[num]);
                renderYAxis(result.data[num]);
                renderBody(svg, result.data[num]);
            }
            /**
             * 合并选择的集合
             */
            $("#merge").click(function () {
                var binNums = Math.min(start, end) + "," + Math.max(start, end);
                $.ajax({
                    url: "http://localhost:8091/tool",
                    type: 'post',
                    data: {
                        "binNums": binNums
                    },
                    async: true,
                    success: function (result) {
                        for (var num = 0; num < result.data.length; num++) {
                            console.log(result.data);
//                            $('.axis').html("");
//                            $('#data_table').find('tbody').html("");
                            initPanel(num);
                            renderXAxis(result.data);
                            renderYAxis(result.data);
                            renderBody(svg, result.data,num);
                        }
                    }
                });
            })
        });
    });

    function initPanel(num) {
        //设置画布
        svg = d3.select("body")
            .select("div")
            .append("div")
            .attr("id", num)
            .append("svg")
            .attr("class", "axis")
            .attr("width", width)
            .attr("height", height);

        //设置与之对其的表格
        var p_table = d3.select("body")
            .select("div").select("div")
            .append("div")
            .attr("class", "sheet");

        var table = p_table.append("table")
            .attr("class", "table table-bordered");

        var tr = table.append("thead").append("tr");
        tr.append("td").text("bin_num");
        tr.append("td").text("woe");
        var tbody = table.append("tbody").attr("id","tbody_"+num);


        //设置按钮
        d3.select("body")
            .select("div")
            .append("div")
            .append("button")
            .attr("class", "btn btn-primary")
            .attr("id", "btn" + num)
            .attr("disabled", "disabled")
            .text("执行合并")
            .style("margin-left","25px");

return svg
    }
    /**
     * 描绘x轴
     */
    function renderXAxis(data) {
        var axisLength = width - 2 * margin;

        //设定比例
        xScale = d3.scaleLinear()
            .domain([-0.5, 0.2])//数值范围
            .range([0, axisLength]);//该范围在屏幕内展示的长度

        //ticks表示我们希望的刻度数,会根据数值调整
        var axis = d3.axisBottom(xScale).ticks(5);

        svg.append("g")
            .attr("class", "x-axis")
            .attr("transform", function () {
                return "translate(" + margin + "," + 475 + ")";
            }).call(axis);


        d3.selectAll("g.x-axis g.tick")
            .attr("stroke", "#777")
            .attr("stroke-dasharray", "2,2") //设置虚线
            .append("line")
            .attr("x1", 0)
            .attr("y1", 0)
            .attr("x2", 0)
            .attr("y2", -(height - 2 * margin));
    }

    /**
     * 描绘y轴
     */
    function renderYAxis(data) {
        var axisLength = width - 2 * margin;
        //设定比例
        yScale = d3.scaleBand()
            .range([0, axisLength]).padding(0.1);
        yScale.domain(data.map(function (d) {
            return d.bin_num;
        }));

        var axis = d3.axisLeft(yScale);

        svg.append("g")
            .attr("class", "y-axis")
            .attr("transform", function () {
                return "translate(" + margin + "," + margin + ")";
            }).call(axis);


        d3.selectAll("g.x-axis")
        //            .attr("stroke", "#777")
        //            .attr("stroke-dasharray", "2,2") //设置虚线
            .append("line")
            .attr("x1", 0)
            .attr("y1", 0)
            .attr("x2", axisLength)
            .attr("y2", 0);
    }

    var body;
    function renderBody(svg, data,num) {
        if (!body) {
            body = svg.append("g")
                .attr("class", "body");
        }
        renderBars(data);

        var tbody=d3.select("#tobody_"+num);
        for (var obj of array) {
            console.log(obj);
          var tr=  tbody.append("tr");
            tr.append("td").append(obj.bin_num);
            tr.append(obj.woe);
        }

    }

    /**
     * 绘制条状物
     */
    function renderBars(data) {
        svg.selectAll(".MyRect")
            .data(data)
            .enter()
            .append("rect")
            .attr("class", "MyRect")
            .attr("fill", "steelblue")//设定bar的颜色
            .attr("id", function (d) {//绑定id
                return "index_" + d.bin_num;
            })
            .attr("transform", "translate(" + padding.left + "," + 40 + ")")//设置偏移位置
            .attr("x", function (d) {
                return xScale(Math.min(0, d.woe)); //根据woe值设置x轴的位置
            })
            .attr("y", function (d) {
//                console.log(yScale(d.bin_num));
                return yScale(d.bin_num);//根据bin_num的值设定y轴的值
            })
            .attr("width", function (d) {
                return Math.abs(xScale(d.woe) - xScale(0));//根据woe设置宽度
            })
            .attr("height", function (d) {
                return 50;//设置高度
            });

        buttonInit();

//        var height = yScale(data[1].bin_num) - yScale(data[0].bin_num);
//        var tbody = $('#data_table').find('tbody');
//
//        for (var a = 0; a < data.length; a++) {
//            tbody.append("<tr>" +
//                "<td>" + data[a].bin_num + "</td>" +
//                "<td>" + data[a].woe + "</td>" +
//                "</tr>");
//            var tr = tbody.find("tr").attr("height", height);
//        }
    }

    function buttonInit() {
        /**
         * 前后点击两次点击bar,可以多选,第三次会重置,重新开始选择
         */
        $('.MyRect').click(function () {
            console.log(123);
            if (array.length == 1) {
                var val = $(this).attr("id");
                var index = val.split("_")[1];
                if (!start) {
                    $("#" + val).attr("fill", "brown");
                    start = index;
                } else if (!end) {
                    end = index;
                }
                //如果前后两次都点击完毕,会按照次序将bar填充颜色.并在数组里添加记录
                if (start && end) {
                    for (var i = Math.min(start, end); i <= Math.max(start, end); i++) {
                        var bar = $("#index_" + i);
                        array.push(bar);
                        bar.attr("fill", "brown");
                    }
                }
            } else {
                //将之前数组中添加的记录提取出来,重置颜色
                for (var m = 0; m < array.length; m++) {
                    array[m].attr("fill", "steelblue");
                }
                array = [];
                end = null;
                array.push($(this));
                $(this).attr("fill", "brown");
                start = $(this).attr("id").split("_")[1];
            }

            if (start && end) {
                $("#merge").removeAttr("disabled");
            } else {
                $("#merge").attr("disabled", "disabled");
            }
        });
    }
</script>

</html>